/*
  Copyright 2021 Adobe. All rights reserved.
  This file is licensed to you under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License. You may obtain a copy
  of the License at http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software distributed under
  the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS
  OF ANY KIND, either express or implied. See the License for the specific language
  governing permissions and limitations under the License.
*/

package com.adobe.marketing.mobile.edge.identity;

import static com.adobe.marketing.mobile.edge.identity.util.IdentityFunctionalTestUtil.*;
import static org.junit.Assert.*;

import androidx.test.ext.junit.runners.AndroidJUnit4;
import com.adobe.marketing.mobile.MobileCore;
import com.adobe.marketing.mobile.MobilePrivacyStatus;
import com.adobe.marketing.mobile.edge.identity.util.MonitorExtension;
import com.adobe.marketing.mobile.edge.identity.util.TestHelper;
import java.util.Arrays;
import java.util.HashMap;
import org.junit.Rule;
import org.junit.Test;
import org.junit.rules.TestRule;
import org.junit.runner.RunWith;

@RunWith(AndroidJUnit4.class)
public class IdentityECIDHandlingTest {

	@Rule
	public TestRule rule = new TestHelper.SetupCoreRule();

	private static final HashMap<String, Object> TEST_CONFIG = new HashMap<String, Object>() {
		{
			put("global.privacy", "optedin");
			put("experienceCloud.org", "testOrg@AdobeOrg");
			put("experienceCloud.server", "notaserver");
		}
	};

	@Test
	public void testECID_autoGeneratedWhenBooted() throws InterruptedException {
		// setup
		registerExtensions(Arrays.asList(MonitorExtension.EXTENSION, Identity.EXTENSION), null);

		// verify ECID is not null
		verifyPrimaryECIDNotNull();
	}

	@Test
	public void testECID_loadedFromPersistence() throws Exception {
		// setup
		setEdgeIdentityPersistence(
			createXDMIdentityMap(new TestItem("ECID", "primaryECID"), new TestItem("ECID", "secondaryECID"))
		);
		registerExtensions(Arrays.asList(MonitorExtension.EXTENSION, Identity.EXTENSION), null);

		// verify
		verifyPrimaryECID("primaryECID");
		verifySecondaryECID("secondaryECID");
	}

	@Test
	public void testECID_edgePersistenceTakesPreferenceOverDirectExtension() throws Exception {
		// setup
		setIdentityDirectPersistedECID("legacyECID");
		setEdgeIdentityPersistence(createIdentityMap("ECID", "edgeECID").asXDMMap(false));
		registerExtensions(Arrays.asList(MonitorExtension.EXTENSION, Identity.EXTENSION), null);

		// verify
		verifyPrimaryECID("edgeECID");
		verifySecondaryECID(null);
	}

	@Test
	public void testECID_loadsIdentityDirectECID() throws Exception {
		// This will happen when EdgeIdentity extension is installed after Identity direct extension
		// setup
		setIdentityDirectPersistedECID("legacyECID");
		registerExtensions(Arrays.asList(MonitorExtension.EXTENSION, Identity.EXTENSION), null);

		// verify
		verifyPrimaryECID("legacyECID");
	}

	@Test
	public void testECID_whenBothExtensionRegistered_install() throws Exception {
		// setup
		registerExtensions(
			Arrays.asList(
				MonitorExtension.EXTENSION,
				Identity.EXTENSION,
				com.adobe.marketing.mobile.Identity.EXTENSION
			),
			TEST_CONFIG
		); // no ECID exists before this step

		String directECID = getIdentityDirectECIDSync();
		String edgeECID = getExperienceCloudIdSync();

		// verify ECID
		verifyPrimaryECID(directECID);
		verifySecondaryECID(null);
		assertEquals(directECID, edgeECID);
	}

	@Test
	public void testECID_whenBothExtensionRegistered_migrationPath() throws Exception {
		// setup
		String existingECID = "legacyECID";
		setIdentityDirectPersistedECID(existingECID);
		registerExtensions(
			Arrays.asList(
				MonitorExtension.EXTENSION,
				Identity.EXTENSION,
				com.adobe.marketing.mobile.Identity.EXTENSION
			),
			TEST_CONFIG
		);

		String directECID = getIdentityDirectECIDSync();
		String edgeECID = getExperienceCloudIdSync();

		// verify ECID
		verifyPrimaryECID(directECID);
		verifySecondaryECID(null);
		assertEquals(directECID, edgeECID);
		assertEquals(existingECID, edgeECID);
	}

	@Test
	public void testECID_onResetClearsOldECID() throws Exception {
		// setup
		setEdgeIdentityPersistence(
			createXDMIdentityMap(new TestItem("ECID", "primaryECID"), new TestItem("ECID", "secondaryECID"))
		);
		registerExtensions(Arrays.asList(MonitorExtension.EXTENSION, Identity.EXTENSION), null);

		// test
		MobileCore.resetIdentities();
		String newECID = getExperienceCloudIdSync();

		// verify the new ecid is not the same as old one and the secondary ECID is cleared
		assertNotNull(newECID);
		assertNotEquals("primaryECID", newECID);
		verifyPrimaryECID(newECID);
		verifySecondaryECID(null);
	}

	@Test
	public void testECID_AreDifferentAfterPrivacyChange() throws Exception {
		/// Test Edge Identity and IdentityDirect have same ECID on bootup, and after privacy change ECIDs are different
		setIdentityDirectPersistedECID("legacyECID");
		registerExtensions(
			Arrays.asList(
				MonitorExtension.EXTENSION,
				Identity.EXTENSION,
				com.adobe.marketing.mobile.Identity.EXTENSION
			),
			TEST_CONFIG
		);
		TestHelper.waitForThreads(2000);

		// verify ECID for both extensions are same
		String directECID = getIdentityDirectECIDSync();
		String edgeECID = getExperienceCloudIdSync();
		assertEquals("legacyECID", edgeECID);
		assertEquals(directECID, edgeECID);

		//  Toggle privacy
		togglePrivacyStatus();
		directECID = getIdentityDirectECIDSync();

		// verify legacy ECID added to IdentityMap
		verifyPrimaryECID(edgeECID);
		verifySecondaryECID(directECID);
	}

	@Test
	public void testECID_AreDifferentAfterResetIdentitiesAndPrivacyChange() throws Exception {
		/// Test Edge Identity and IdentityDirect have same ECID on bootup, and after resetIdentities and privacy change ECIDs are different

		// 1) Register Identity then Edge Identity and verify both have same ECID
		setIdentityDirectPersistedECID("legacyECID");

		registerExtensions(
			Arrays.asList(
				MonitorExtension.EXTENSION,
				Identity.EXTENSION,
				com.adobe.marketing.mobile.Identity.EXTENSION
			),
			TEST_CONFIG
		);

		TestHelper.waitForThreads(2000);

		// verify ECID for both extensions are same
		String directECID = getIdentityDirectECIDSync();
		String edgeECID = getExperienceCloudIdSync();
		assertEquals("legacyECID", edgeECID);
		assertEquals(directECID, edgeECID);

		// 2) Reset identities and toggle privacy and verify legacy ECID added to IdentityMap
		MobileCore.resetIdentities();
		togglePrivacyStatus();

		// verify
		directECID = getIdentityDirectECIDSync();
		edgeECID = getExperienceCloudIdSync();
		verifyPrimaryECID(edgeECID);
		verifySecondaryECID(directECID);
	}

	@Test
	public void testECID_DirectEcidIsRemovedOnPrivacyOptOut() throws Exception {
		// setup
		setIdentityDirectPersistedECID("legacyECID");
		setEdgeIdentityPersistence(createIdentityMap("ECID", "edgeECID").asXDMMap(false));

		registerExtensions(
			Arrays.asList(
				MonitorExtension.EXTENSION,
				Identity.EXTENSION,
				com.adobe.marketing.mobile.Identity.EXTENSION
			),
			TEST_CONFIG
		);

		// verify ECID
		verifyPrimaryECID("edgeECID");
		verifySecondaryECID("legacyECID");

		// Set privacy opted-out
		MobileCore.setPrivacyStatus(MobilePrivacyStatus.OPT_OUT);
		TestHelper.waitForThreads(2000);

		// verify that the secondary ECID is removed
		verifyPrimaryECID("edgeECID");
		verifySecondaryECID(null);
	}

	// --------------------------------------------------------------------------------------------
	// private helpers methods
	// --------------------------------------------------------------------------------------------

	private void togglePrivacyStatus() {
		MobileCore.setPrivacyStatus(MobilePrivacyStatus.OPT_OUT);
		MobileCore.setPrivacyStatus(MobilePrivacyStatus.OPT_IN);
		TestHelper.waitForThreads(2000);
	}
}
